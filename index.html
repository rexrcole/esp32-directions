<!DOCTYPE html>
<html>
<head>
  <title>ESP32 GPS Directions with Departure Option</title>
  <meta charset="utf-8" />
  <style>
    #map { height: 60vh; width: 100%; margin-bottom: 10px; }
    label { font-weight: bold; }
    input { width: 300px; margin-bottom: 8px; }
    #directionsList {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      font-family: Arial, sans-serif;
      background: #f9f9f9;
    }
    #directionsList ol {
      padding-left: 20px;
      margin: 0;
    }
    #directionsList li {
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <h1>Car-Like GPS for ESP32</h1>

  <label for="departure">Departure (leave empty for current location):</label><br />
  <input id="departure" type="text" placeholder="Enter departure location" size="50" /><br />

  <label for="destination">Destination:</label><br />
  <input id="destination" type="text" placeholder="Enter destination" size="50" /><br />

  <button onclick="getRoute()">Start Navigation</button>
  <div id="map"></div>
  <div id="status"></div>

  <div id="directionsList" style="display:none;">
    <h2>Directions:</h2>
    <ol id="stepsList"></ol>
  </div>

  <script>
    let map, directionsService, directionsRenderer;
    let routeSteps = [];
    let currentStepIndex = 0;
    let esp32IP = "https://esp32-sever.onrender.com";
    let watchId = null;

    let autocompleteDeparture, autocompleteDestination;
    let selectedDeparture = null;
    let selectedDestination = null;

    function initMap() {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const currentPos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
          };

          map = new google.maps.Map(document.getElementById("map"), {
            center: currentPos,
            zoom: 15,
          });

          new google.maps.Marker({
            position: currentPos,
            map: map,
          });

          directionsService = new google.maps.DirectionsService();
          directionsRenderer = new google.maps.DirectionsRenderer({ map });

          // Departure autocomplete
          const departureInput = document.getElementById("departure");
          autocompleteDeparture = new google.maps.places.Autocomplete(departureInput);
          autocompleteDeparture.setFields(["formatted_address", "geometry"]);
          autocompleteDeparture.addListener("place_changed", () => {
            selectedDeparture = autocompleteDeparture.getPlace();
            if (!selectedDeparture.geometry) {
              alert("Please select a departure place from the dropdown.");
              selectedDeparture = null;
              departureInput.value = "";
            }
          });

          // Destination autocomplete
          const destinationInput = document.getElementById("destination");
          autocompleteDestination = new google.maps.places.Autocomplete(destinationInput);
          autocompleteDestination.setFields(["formatted_address", "geometry"]);
          autocompleteDestination.addListener("place_changed", () => {
            selectedDestination = autocompleteDestination.getPlace();
            if (!selectedDestination.geometry) {
              alert("Please select a destination place from the dropdown.");
              selectedDestination = null;
              destinationInput.value = "";
            }
          });

          document.getElementById("status").innerText = "Map loaded. Enter locations.";
        },
        (error) => {
          alert("Error getting location: " + error.message);
        }
      );
    }

    function getRoute() {
      if (!selectedDestination) {
        alert("Please select a destination from the dropdown.");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          // Use selected departure if given, else current location
          let originCoordsPromise;
          if (selectedDeparture && selectedDeparture.geometry) {
            originCoordsPromise = Promise.resolve({
              lat: selectedDeparture.geometry.location.lat(),
              lng: selectedDeparture.geometry.location.lng(),
            });
          } else {
            originCoordsPromise = Promise.resolve({
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            });
          }

          originCoordsPromise.then((origin) => {
            directionsService.route(
              {
                origin: origin,
                destination: selectedDestination.formatted_address,
                travelMode: google.maps.TravelMode.DRIVING,
              },
              (result, status) => {
                if (status === "OK") {
                  directionsRenderer.setDirections(result);
                  routeSteps = result.routes[0].legs[0].steps;
                  currentStepIndex = 0;

                  // Show directions list
                  displayDirectionsList(routeSteps);

                  if (watchId !== null) {
                    navigator.geolocation.clearWatch(watchId);
                  }

                  watchId = navigator.geolocation.watchPosition(
                    (pos) => {
                      const myPos = {
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude,
                      };
                      updateStep(myPos);
                    },
                    (error) => {
                      console.error("Error watching position:", error);
                    },
                    {
                      enableHighAccuracy: true,
                      maximumAge: 0,
                      timeout: 10000,
                    }
                  );

                  document.getElementById("status").innerText = "Navigation started.";
                } else {
                  alert("Directions request failed: " + status);
                }
              }
            );
          });
        },
        (error) => {
          alert("Error getting location: " + error.message);
        }
      );
    }

    function displayDirectionsList(steps) {
      const directionsDiv = document.getElementById("directionsList");
      const stepsList = document.getElementById("stepsList");
      stepsList.innerHTML = "";

      steps.forEach((step, index) => {
        const li = document.createElement("li");
        li.innerHTML = step.instructions;
        stepsList.appendChild(li);
      });

      directionsDiv.style.display = "block";
    }

    function updateStep(myPos) {
      if (currentStepIndex >= routeSteps.length) return;

      const step = routeSteps[currentStepIndex];
      const distance = google.maps.geometry.spherical.computeDistanceBetween(
        new google.maps.LatLng(myPos.lat, myPos.lng),
        step.end_location
      );

      if (distance < 50 && currentStepIndex < routeSteps.length - 1) {
        currentStepIndex++;
      }

      sendToESP32(routeSteps[currentStepIndex].instructions.replace(/<[^>]+>/g, ""));
    }

    function sendToESP32(text) {
      fetch(esp32IP, {
        method: "POST",
        headers: { "Content-Type": "text/plain" },
        body: text,
      })
        .then(() => {
          console.log("Sent to ESP32:", text);
        })
        .catch((err) => {
          console.error("ESP32 error:", err);
        });
    }
  </script>

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAdx4nTqzyGmM6yJeGBeiHoyCsAG-Hc2bM&libraries=geometry,places&callback=initMap&loading=async"
    async
    defer
  ></script>
</body>
</html>


